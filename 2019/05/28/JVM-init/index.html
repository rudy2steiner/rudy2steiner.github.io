<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>从Hotspot对象实例化过程，理解类加载 | Rudy Steiner's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">从Hotspot对象实例化过程，理解类加载</h1><a id="logo" href="/.">Rudy Steiner's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从Hotspot对象实例化过程，理解类加载</h1><div class="post-meta">May 28, 2019</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#类加载"><span class="toc-number">1.</span> <span class="toc-text">类加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类的实例化"><span class="toc-number">2.</span> <span class="toc-text">类的实例化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#追问"><span class="toc-number">3.</span> <span class="toc-text">追问</span></a></li></ol></div></div><div class="post-content"><p>Java 对象的实例化JVM都做了那些事情？在日常编写Java项目的时候，实例化过无数多的对象，随时都在与JVM交互！对JVM的认识总是停留在只是知道它能解析识别，并加载运行Java编写的程序，好奇心驱使着我开始关注JVM是如何实现这一系列功能的。</p>
<p>即使读过《深入理解Java虚拟机》，对JVM的理解也只是达到一个入门的程度，开源的JVM实现凤毛菱角，为大家所熟知的OpenJDK自然成为了想一探究竟的入口，经过一番的搜寻，发现另外一本《Hotspot实战》让我看到了一丝希望。这本书买过来在我的书桌有一段时间了，最近终于有空仔细阅读了前面三章的内容，但纸上得来终觉浅，源码面前无秘密，跟着这本书终于满足我对JVM的一丝好奇心。</p>
<p>面对Hotspot如此庞大的工程，并且C++语言对大多数人也不太熟悉，项目的入口在哪里？这个我目前也不太清楚；我最关心的是什么？main、Launcher、new关键字大概是我最想了解的，类加载恰好可以串联它们。第一篇JVM相关的博客，看书和写博客都是都是慢长的过程（个人感觉），有些东西不值得看，也不值得写，JVM属于另外一类，那就抽空看，再慢慢写。</p>
<h2 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h2><p>一个class文件，需要依次完成加载、链接、初始化三个阶段，才可以在JVM中正常的使用。如创建实例，访问类的静态方法和域。<br>主要步骤如下：</p>
<p>1 class 文件加载完成hook，提供parse前改变字节码的能力<br>2 读取魔数、大版本和小版本号、类的常量池(符号引用)、访问标示<br>3 解析类的接口、域、方法及父类<br>4 计算vtable 和 itable 大小<br>5 创建InstanceKlass<br>6 创建Java 镜像类,并初始化静态成员变量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">instanceKlassHandle ClassFileParser::parseClassFile(Symbol* name,</span><br><span class="line">                                                ClassLoaderData* loader_data,</span><br><span class="line">                                                Handle protection_domain,</span><br><span class="line">                                                KlassHandle host_klass,</span><br><span class="line">                                                GrowableArray&lt;Handle&gt;* cp_patches,</span><br><span class="line">                                                TempNewSymbol&amp; parsed_name,</span><br><span class="line">                                                <span class="keyword">bool</span> verify,</span><br><span class="line">                                                TRAPS) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    JvmtiExport::post_class_file_load_hook(...); <span class="comment">// class file load hook</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Magic value</span></span><br><span class="line">     u4 magic = cfs-&gt;get_u4_fast();</span><br><span class="line">     <span class="comment">// Version numbers</span></span><br><span class="line">     u2 minor_version = cfs-&gt;get_u2_fast();</span><br><span class="line">     u2 major_version = cfs-&gt;get_u2_fast();</span><br><span class="line"></span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Constant pool</span></span><br><span class="line">    constantPoolHandle cp = parse_constant_pool(...);</span><br><span class="line"></span><br><span class="line">     ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Access flags</span></span><br><span class="line">    access_flags.set_flags(flags);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Interfaces</span></span><br><span class="line">    Array&lt;Klass*&gt;* local_interfaces =parse_interfaces(...);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Fields (offsets are filled in later)</span></span><br><span class="line">    Array&lt;u2&gt;* fields = parse_fields(...);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Methods</span></span><br><span class="line">    Array&lt;Method*&gt;* methods = parse_methods(...);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finalize the Annotations metadata object,</span></span><br><span class="line">    <span class="comment">// now that all annotation arrays have been created.</span></span><br><span class="line">    create_combined_annotations(CHECK_(nullHandle));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Supper class</span></span><br><span class="line">    Klass* k = SystemDictionary::resolve_super_or_fail(...);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compute the transitive list of all unique interfaces implemented by this class</span></span><br><span class="line">    transitive_interfaces =compute_transitive_interfaces(super_klass, local_interfaces, CHECK_(nullHandle));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// vtable and itable size</span></span><br><span class="line">     klassVtable::compute_vtable_size_and_num_mirandas(...)</span><br><span class="line">     klassItable::compute_itable_size(transitive_interfaces);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can now create the basic Klass* for this klass</span></span><br><span class="line">    InstanceKlass* kclass=InstanceKlass::allocate_instance_klass(...);</span><br><span class="line">    <span class="function">instanceKlassHandle <span class="title">this_klass</span><span class="params">(THREAD, klass)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate mirror and initialize static fields</span></span><br><span class="line">    java_lang_Class::create_mirror(this_klass, class_loader,...);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify class load  </span></span><br><span class="line">    ClassLoadingService::notify_class_loaded(InstanceKlass::cast(this_klass()),<span class="literal">false</span> <span class="comment">/* not shared class */</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类的实例化"><a href="#类的实例化" class="headerlink" title="类的实例化"></a>类的实例化</h2><p>  从虚拟机层面来看，所有的Java构造函数都显示为具有特殊名称<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html" target="_blank" rel="noopener"> &lt;init&gt; </a>的实例初始化方法。Hotspot中调用&lt;init&gt;的代码如下：</p>
<p>vmSymbols.h 头文件包含object_initializer_name：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* common method and field names */</span>           </span><br><span class="line"><span class="keyword">template</span>(object_initializer_name,                <span class="string">"&lt;init&gt;"</span>)  </span><br><span class="line"><span class="keyword">template</span>(class_initializer_name,               <span class="string">"&lt;clinit&gt;"</span>)</span><br></pre></td></tr></table></figure>
<p>jvm.cpp</p>
<pre><code class="c++">  JVM_AllocateNewObject(JNIEnv *env,
                        jobject receiver,
                        jclass currClass,
                        jclass initClass){
    ......                      
    <span class="function">methodHandle <span class="title">m</span><span class="params">(THREAD,init_klass-&gt;find_method(vmSymbols::object_initializer_name(),vmSymbols::void_method_signature()))</span></span>;
    Handle obj = curr_klass-&gt;allocate_instance_handle(CHECK_NULL);

    <span class="comment">// Call constructor m. This might call a constructor higher up in the hierachy</span>
    JavaCalls::call_default_constructor(thread, m, obj, CHECK_NULL);
}

</code></pre>
<p>待续…</p>
<h2 id="追问"><a href="#追问" class="headerlink" title="追问"></a>追问</h2><ul>
<li><p>Java如何实现重载以及重写的？</p>
</li>
<li><p>一个对象最少占用多大的内存？</p>
</li>
</ul>
</div><div class="tags"><a href="/tags/JVM/">JVM</a><a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/">类加载</a></div><div class="post-nav"><a class="pre" href="/2019/08/09/jdk-update/">JDK 7、8及9中虚拟机的变化</a><a class="next" href="/2019/03/18/transaction/">Distributed transaction</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://rudy2steiner.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">线程</a> <a href="/tags/CPU-Load/" style="font-size: 15px;">CPU Load</a> <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93%EF%BC%8C%E8%B6%8B%E5%8A%BF/" style="font-size: 15px;">年终总结，趋势</a> <a href="/tags/Distributed-theory/" style="font-size: 15px;">Distributed theory</a> <a href="/tags/CAP%E5%AE%9A%E7%90%86/" style="font-size: 15px;">CAP定理</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" style="font-size: 15px;">类加载</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/filesystem/" style="font-size: 15px;">filesystem</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">博客翻译</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">翻译</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/XA/" style="font-size: 15px;">XA</a> <a href="/tags/ZAB/" style="font-size: 15px;">ZAB</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/01/01/2020/">2020 年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/20/how-contribute-kubernetes/">如果你有全职工作，如何为Kubernetes做贡献</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/26/busy-thread/">CPU高负载</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/09/kafka/">Kafka server 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/04/raft/">Raft 算法及实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/27/zookeeper-starter/">Zookeeper server 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/13/Distributed-system/">Distributed System Basics</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/09/jdk-update/">JDK 7、8及9中虚拟机的变化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/28/JVM-init/">从Hotspot对象实例化过程，理解类加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/18/transaction/">Distributed transaction</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Rudy Steiner's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>