<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CPU高负载 | Rudy Steiner's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CPU高负载</h1><a id="logo" href="/.">Rudy Steiner's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CPU高负载</h1><div class="post-meta">May 26, 2020</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#进程负载"><span class="toc-number">1.</span> <span class="toc-text">进程负载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线程负载"><span class="toc-number">1.1.</span> <span class="toc-text">线程负载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进程栈状态"><span class="toc-number">2.</span> <span class="toc-text">进程栈状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Q-amp-A"><span class="toc-number">3.</span> <span class="toc-text">Q&amp;A</span></a></li></ol></div></div><div class="post-content"><p>在开发和运维系统过程中，难免会碰到CPU负载异常高的问题，第一印象是边界情况没处好，导致死循环。如何快速定位占用CPU的线程，甚至具体的代码块，对于解决线上问题非常关键。结合Linux自带的top命令和Java jstack可以轻松解决。</p>
<h2 id="进程负载"><a href="#进程负载" class="headerlink" title="进程负载"></a>进程负载</h2><p>Linux top 命令会展示系统当前的整体负载(load average)情况以及进程所占用的资源(PID、CPU、Memory等)，如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">top - 21:23:19 up 588 days,  3:17,  1 user,  load average: 3.28, 3.84, 4.55</span><br><span class="line">Tasks: 417 total,   2 running, 415 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  8.4 us,  3.6 sy,  0.0 ni, 87.7 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class="line">KiB Mem : 13141572+total,  4651624 free, 83008648 used, 43755452 buff&#x2F;cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 43701956 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 9161 admin     20   0  0.105t 0.065t  15768 S 1709.2 53.4 109998:58 java</span><br><span class="line">17551 root      20   0 3690796  32624   2548 S  18.8  0.0 309:22.70 lsecd</span><br><span class="line">26748 root      20   0  146408   2156   1376 R   6.2  0.0   0:00.01 top</span><br><span class="line">    1 root      20   0 1403740 1.162g   1852 S   0.0  0.9 185:42.10 systemd</span><br><span class="line">    2 root      20   0       0      0      0 S   0.0  0.0   5:18.52 kthreadd</span><br><span class="line">    3 root      20   0       0      0      0 S   0.0  0.0  99:12.84 ksoftirqd&#x2F;0</span><br><span class="line">    5 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker&#x2F;0:+</span><br><span class="line">    8 root      rt   0       0      0      0 S   0.0  0.0  42:23.68 migration&#x2F;0</span><br><span class="line">    9 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcu_bh</span><br><span class="line">   10 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcuob&#x2F;0</span><br><span class="line">   11 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcuob&#x2F;1</span><br><span class="line">   12 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcuob&#x2F;2</span><br></pre></td></tr></table></figure></p>
<h3 id="线程负载"><a href="#线程负载" class="headerlink" title="线程负载"></a>线程负载</h3><p>观察具体进程的线程负载，可以通过top -Hp pid。通过man top查看下 —H选项的含义:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-H  :Threads-mode operation</span><br><span class="line">    Instructs top to display individual  threads.   Without  this</span><br><span class="line">    command-line  option  a  summation  of  all  threads  in each</span><br><span class="line">    process is shown.  Later this can be  changed  with  the  &#96;H&#39;</span><br><span class="line">    interactive command.</span><br></pre></td></tr></table></figure></p>
<p>top -Hp 9161 显示如下结果，通过交互命令P对线程按cpu占用排序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">24030 admin     20   0 49.789g 0.021t   3208 R 70.8 17.4   8200:13 java</span><br><span class="line">24027 admin     20   0 49.789g 0.021t   3208 R 70.1 17.4   8204:32 java</span><br><span class="line">24020 admin     20   0 49.789g 0.021t   3208 R 69.4 17.4   8199:30 java</span><br><span class="line">24034 admin     20   0 49.789g 0.021t   3208 R 69.4 17.4   8200:41 java</span><br><span class="line">24018 admin     20   0 49.789g 0.021t   3208 R 69.1 17.4   8205:10 java</span><br><span class="line">24024 admin     20   0 49.789g 0.021t   3208 R 69.1 17.4   8203:03 java</span><br><span class="line">24023 admin     20   0 49.789g 0.021t   3208 R 68.4 17.4   8197:42 java</span><br><span class="line">24036 admin     20   0 49.789g 0.021t   3208 R 68.4 17.4   8197:41 java</span><br><span class="line">24037 admin     20   0 49.789g 0.021t   3208 R 68.4 17.4   8205:43 java</span><br><span class="line">24029 admin     20   0 49.789g 0.021t   3208 R 68.1 17.4   8200:24 java</span><br><span class="line">24026 admin     20   0 49.789g 0.021t   3208 R 67.8 17.4   8199:40 java</span><br><span class="line">24019 admin     20   0 49.789g 0.021t   3208 R 67.1 17.4   8203:19 java</span><br><span class="line">24032 admin     20   0 49.789g 0.021t   3208 R 66.8 17.4   8202:12 java</span><br><span class="line">24016 admin     20   0 49.789g 0.021t   3208 R 66.4 17.4   8203:41 java</span><br><span class="line">24025 admin     20   0 49.789g 0.021t   3208 R 66.4 17.4   8200:08 java</span><br><span class="line">24031 admin     20   0 49.789g 0.021t   3208 R 66.1 17.4   8203:23 java</span><br><span class="line">24028 admin     20   0 49.789g 0.021t   3208 R 65.4 17.4   8208:02 java</span><br><span class="line">24017 admin     20   0 49.789g 0.021t   3208 R 65.1 17.4   8202:28 java</span><br><span class="line">24022 admin     20   0 49.789g 0.021t   3208 R 64.8 17.4   8197:14 java</span><br><span class="line">24033 admin     20   0 49.789g 0.021t   3208 R 64.8 17.4   8197:24 java</span><br><span class="line">24038 admin     20   0 49.789g 0.021t   3208 R 62.8 17.4   8202:43 java</span><br><span class="line">24035 admin     20   0 49.789g 0.021t   3208 R 62.5 17.4   8201:33 java</span><br><span class="line">24021 admin     20   0 49.789g 0.021t   3208 R 61.5 17.4   8198:19 java</span><br><span class="line">24039 admin     20   0 49.789g 0.021t   3208 S 23.6 17.4   4096:35 java</span><br></pre></td></tr></table></figure></p>
<p>将高负载线程保存到tid.txt，利用单行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat tid.txt|awk &#39;&#123;printf &quot;%d,%x\n&quot;,$1,$1&#125;&#39;</span><br></pre></td></tr></table></figure><br>将线程id 转化为十六进制，后续jstack tid采用hex 显示。结果如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">24029,5ddd</span><br><span class="line">24024,5dd8</span><br><span class="line">24034,5de2</span><br><span class="line">24022,5dd6</span><br><span class="line">24030,5dde</span><br><span class="line">24017,5dd1</span><br><span class="line">24033,5de1</span><br><span class="line">24018,5dd2</span><br><span class="line">24032,5de0</span><br><span class="line">24016,5dd0</span><br><span class="line">24021,5dd5</span><br><span class="line">24026,5dda</span><br><span class="line">24038,5de6</span><br><span class="line">24027,5ddb</span><br><span class="line">24028,5ddc</span><br><span class="line">24020,5dd4</span><br><span class="line">24037,5de5</span><br><span class="line">24019,5dd3</span><br><span class="line">24023,5dd7</span><br><span class="line">24035,5de3</span><br><span class="line">24031,5ddf</span><br><span class="line">24036,5de4</span><br><span class="line">24025,5dd9</span><br></pre></td></tr></table></figure></p>
<h2 id="进程栈状态"><a href="#进程栈状态" class="headerlink" title="进程栈状态"></a>进程栈状态</h2><p>利用jstack 获取进程的线程栈，命令jstack 9161 &gt;stack.txt，利用grep 命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 9161.txt |grep -C 10 5ddd</span><br></pre></td></tr></table></figure><br>查找目标线程栈如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&quot;GC task thread#8 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f569002f800 nid&#x3D;0x5dd8 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#9 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690031000 nid&#x3D;0x5dd9 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#10 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690033000 nid&#x3D;0x5dda runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#11 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690035000 nid&#x3D;0x5ddb runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#12 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690036800 nid&#x3D;0x5ddc runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#13 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690038800 nid&#x3D;0x5ddd runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#14 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f569003a800 nid&#x3D;0x5dde runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#15 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f569003c000 nid&#x3D;0x5ddf runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#16 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f569003e000 nid&#x3D;0x5de0 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#17 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690040000 nid&#x3D;0x5de1 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#18 (ParallelGC)&quot; os_prio&#x3D;0 tid&#x3D;0x00007f5690041800 nid&#x3D;0x5de2 runnable</span><br></pre></td></tr></table></figure></p>
<p>至次,可以确定CPU负载高是由于GC引起的，持续高说明可能存在内存泄漏/或JVM参数配置不合理的问题。</p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><ol>
<li>Jstack 会看到线程当前的状态，线程有哪些状态，状态之间如何转换?<br>通过命令cat 9161.txt |grep ‘ java.lang.Thread.’，结果如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TIMED_WAITING (on object monitor),Object wait</span><br><span class="line">TIMED_WAITING (parking),Unsafe.park</span><br><span class="line">WAITING (parking)</span><br><span class="line">WAITING (on object monitor)</span><br><span class="line">RUNNABLE</span><br><span class="line">BLOCKED (on object monitor),synchronized 等待进入临界区</span><br></pre></td></tr></table></figure>
所以常见的状态有:<ul>
<li>TIME_WAITING</li>
<li>WAITING</li>
<li>RUNNABLE</li>
<li>BLOCKED</li>
</ul>
</li>
</ol>
</div><div class="tags"><a href="/tags/%E7%BA%BF%E7%A8%8B/">线程</a><a href="/tags/CPU-Load/">CPU Load</a></div><div class="post-nav"><a class="pre" href="/2020/06/20/how-contribute-kubernetes/">如果你有全职工作，如何为Kubernetes做贡献</a><a class="next" href="/2020/02/09/kafka/">Kafka server 入门</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://rudy2steiner.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">线程</a> <a href="/tags/CPU-Load/" style="font-size: 15px;">CPU Load</a> <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93%EF%BC%8C%E8%B6%8B%E5%8A%BF/" style="font-size: 15px;">年终总结，趋势</a> <a href="/tags/Distributed-theory/" style="font-size: 15px;">Distributed theory</a> <a href="/tags/CAP%E5%AE%9A%E7%90%86/" style="font-size: 15px;">CAP定理</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" style="font-size: 15px;">类加载</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/filesystem/" style="font-size: 15px;">filesystem</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">博客翻译</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">翻译</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/XA/" style="font-size: 15px;">XA</a> <a href="/tags/ZAB/" style="font-size: 15px;">ZAB</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/01/01/2020/">2020 年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/20/how-contribute-kubernetes/">如果你有全职工作，如何为Kubernetes做贡献</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/26/busy-thread/">CPU高负载</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/09/kafka/">Kafka server 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/04/raft/">Raft 算法及实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/27/zookeeper-starter/">Zookeeper server 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/13/Distributed-system/">Distributed System Basics</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/09/jdk-update/">JDK 7、8及9中虚拟机的变化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/28/JVM-init/">从Hotspot对象实例化过程，理解类加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/18/transaction/">Distributed transaction</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Rudy Steiner's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>